<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Machine Stats Dashboard</title>
<script src="https://unpkg.com/lucide@latest"></script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.11/firebase-app.js";
import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/9.6.11/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyAnHHfwRgKh_Ff1RNmIzf8MYZEMrFsyx2Q",
  authDomain: "shahi-stats-analytics-1.firebaseapp.com",
  databaseURL: "https://shahi-stats-analytics-1-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "shahi-stats-analytics-1",
  storageBucket: "shahi-stats-analytics-1.firebasestorage.app",
  messagingSenderId: "1079393464814",
  appId: "1:1079393464814:web:b48822af5f42aa5c91deff",
  measurementId: "G-XQ5MM7B3M5"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// DOM elements
const nav = document.getElementById("nav");
const mainLabel = document.getElementById("mainLabel");
const mainTotal = document.getElementById("mainTotal");
const fields = ["owned","demo","rented","active","breakdown","idle","moving","warranty","nonWarranty","amc","nonAmc"];

let currentView = { type: "div", div: null, unit: null }; // store current active selection

function updateUI(stats, label) {
  mainLabel.textContent = label;
  mainTotal.textContent = stats.total || 0;
  fields.forEach(f => {
    const el = document.getElementById(f);
    if(el) el.textContent = stats[f] || 0;
  });
}

function clearNavActive() {
  document.querySelectorAll(".nav-card").forEach(el => el.classList.remove("active"));
}

function buildNav(divId, unitKeys) {
  nav.innerHTML = "";
  const divCard = document.createElement("div");
  divCard.className = "nav-card";
  divCard.textContent = divId;
  divCard.onclick = () => loadDiv(divId, divCard);
  nav.appendChild(divCard);

  unitKeys.forEach(u => {
    const unitCard = document.createElement("div");
    unitCard.className = "nav-card";
    unitCard.textContent = u;
    unitCard.onclick = () => loadUnit(divId, u, unitCard);
    nav.appendChild(unitCard);
  });

  // Restore current active card visually
  const currentId = currentView.unit || currentView.div;
  const activeCard = [...nav.children].find(el => el.textContent === currentId);
  if (activeCard) activeCard.classList.add("active");
}

function loadDiv(divId, el) {
  clearNavActive();
  el.classList.add("active");
  currentView = { type: "div", div: divId, unit: null };
  const divRef = ref(db, `divstats/div/${divId}/stats`);
  onValue(divRef, snap => {
    if (snap.exists() && currentView.type === "div" && currentView.div === divId) {
      updateUI(snap.val(), divId);
    }
  });
}

function loadUnit(divId, unitId, el) {
  clearNavActive();
  el.classList.add("active");
  currentView = { type: "unit", div: divId, unit: unitId };
  const unitRef = ref(db, `unitstats/div/${divId}/unit/${unitId}/stats`);
  onValue(unitRef, snap => {
    if (snap.exists() && currentView.type === "unit" && currentView.unit === unitId) {
      updateUI(snap.val(), unitId);
    }
  });
}

// Default load
const urlParams = new URLSearchParams(window.location.search);
const defaultDiv = urlParams.get("div") || "div1";
const unitRef = ref(db, `unitstats/div/${defaultDiv}/unit`);

onValue(unitRef, snap => {
  const unitKeys = snap.exists() ? Object.keys(snap.val()) : [];
  buildNav(defaultDiv, unitKeys);

  // If first time, load div1 by default
  if (!currentView.div && !currentView.unit) {
    loadDiv(defaultDiv, nav.querySelector(".nav-card"));
  } else {
    // If a unit/div is already selected, reload its data without resetting nav
    if (currentView.type === "unit" && currentView.unit) {
      const activeCard = [...nav.children].find(el => el.textContent === currentView.unit);
      if (activeCard) loadUnit(currentView.div, currentView.unit, activeCard);
    } else if (currentView.type === "div" && currentView.div) {
      const activeCard = [...nav.children].find(el => el.textContent === currentView.div);
      if (activeCard) loadDiv(currentView.div, activeCard);
    }
  }
});
</script>
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@3.3.3/dist/tailwind.min.css" rel="stylesheet">
<style>
body {
  font-family: Arial, sans-serif;
  margin: 20px;
  background: #f8f9fa;
}
.nav {
  display: flex;
  gap: 10px;
  margin-bottom: 25px;
  flex-wrap: wrap;
}
.nav-card {
  background: #2E86C1;
  color: white;
  padding: 10px 18px;
  border-radius: 8px;
  cursor: pointer;
  font-weight: 600;
  transition: transform 0.2s ease, background 0.2s ease;
}
.nav-card.active { background: #154360; }
.nav-card:hover { transform: scale(1.05); }
.dashboard {
  display: grid;
  grid-template-columns: 200px 1fr;
  gap: 20px;
}
.main-col {
  background: white;
  border-radius: 12px;
  padding: 20px;
  box-shadow: 0px 3px 8px rgba(0, 0, 0, 0.1);
  text-align: center;
}
.main-col h3 {
  margin-bottom: 10px;
  font-size: 18px;
  color: #2E86C1;
}
.main-col span {
  font-size: 36px;
  font-weight: 600;
  display: block;
  margin-top: 10px;
}
.stats-grid {
  display: flex;
  flex-direction: column;
  gap: 15px;
}
.row {
  display: flex;
  gap: 15px;
  justify-content: flex-start;
  padding: 12px;
  border-radius: 10px;
  border: 1px solid #e0e0e0;
}
.row.ownership { background: #EBF5FB; }
.row.status { background: #FEF9E7; }
.row.other { background: #F5EEF8; }
.card {
  flex: 1;
  padding: 15px;
  border-radius: 10px;
  text-align: left;
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 10px;
  font-weight: 500;
  font-size: 15px;
  box-shadow: 0px 2px 6px rgba(0,0,0,0.2);
  transition: transform 0.2s ease;
}
.card:hover { transform: scale(1.05); }
.card svg { width: 20px; height: 20px; }
.card span {
  font-size: 36px;
  font-weight: 300;
  margin-left: auto;
}
.owned { background: #2E86C1; color: white; }
.demo { background: #6C3483; color: white; }
.rented { background: #D35400; color: white; }
.active { background: #28A745; color: white; }
.breakdown { background: #DC3545; color: white; }
.idle { background: #FFC107; color: #222; }
.moving { background: #17A2B8; color: white; }
.warranty { background: #117A65; color: white; }
.nonwarranty { background: #7D3C98; color: white; }
.amc { background: #CA6F1E; color: white; }
.nonamc { background: #566573; color: white; }
</style>
</head>
<body>
<h2 id="dashboardTitle">Machine Statistics</h2>
<div class="nav" id="nav"></div>

<div class="dashboard">
  <!-- Main col -->
  <div class="main-col">
    <h3 id="mainLabel">Division</h3>
    <span id="mainTotal">0</span>
  </div>

  <!-- Right side grouped stats -->
  <div class="stats-grid">
    <!-- Row 1 Ownership -->
    <div class="row ownership">
      <div class="card owned"><i data-lucide="home"></i> Owned<span id="owned">0</span></div>
      <div class="card demo"><i data-lucide="box"></i> Demo<span id="demo">0</span></div>
      <div class="card rented"><i data-lucide="briefcase"></i> Rented<span id="rented">0</span></div>
    </div>
    <!-- Row 2 Status -->
    <div class="row status">
      <div class="card active"><i data-lucide="play-circle"></i> Active<span id="active">0</span></div>
      <div class="card breakdown"><i data-lucide="alert-triangle"></i> Breakdown<span id="breakdown">0</span></div>
      <div class="card idle"><i data-lucide="pause-circle"></i> Idle<span id="idle">0</span></div>
      <div class="card moving"><i data-lucide="truck"></i> Moving<span id="moving">0</span></div>
    </div>
    <!-- Row 3 Other -->
    <div class="row other">
      <div class="card warranty"><i data-lucide="shield-check"></i> Warranty<span id="warranty">0</span></div>
      <div class="card nonwarranty"><i data-lucide="shield-off"></i> Non-Warranty<span id="nonWarranty">0</span></div>
      <div class="card amc"><i data-lucide="file-text"></i> AMC<span id="amc">0</span></div>
      <div class="card nonamc"><i data-lucide="x-circle"></i> Non-AMC<span id="nonAmc">0</span></div>
    </div>
  </div>
</div>

<script>
  lucide.createIcons();
</script>
</body>
</html>
