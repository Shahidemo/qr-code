<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Barcode Scanner</title>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/minified/html5-qrcode.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .scanner-container {
            background: white;
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            max-width: 500px;
            width: 100%;
            text-align: center;
        }

        .scanner-title {
            font-size: 28px;
            font-weight: 700;
            color: #333;
            margin-bottom: 10px;
        }

        .scanner-subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 16px;
        }

        .scan-button {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 18px;
            font-weight: 600;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
        }

        .scan-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4);
        }

        .scan-button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .stop-button {
            background: linear-gradient(45deg, #f44336, #d32f2f);
            color: white;
            border: none;
            padding: 12px 25px;
            font-size: 16px;
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
            margin: 10px;
            transition: all 0.3s ease;
        }

        .stop-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(244, 67, 54, 0.3);
        }

        #reader {
            margin: 20px auto;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .status-message {
            margin: 15px 0;
            padding: 12px;
            border-radius: 8px;
            font-weight: 500;
        }

        .status-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status-info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .status-warning {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .scanner-hidden {
            display: none;
        }

        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 10px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .iframe-mode {
            background: white;
            min-height: auto;
            padding: 10px;
        }

        .iframe-mode .scanner-container {
            box-shadow: none;
            padding: 10px;
        }

        .debug-info {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            font-size: 14px;
            text-align: left;
        }

        .retry-button {
            background: linear-gradient(45deg, #ff9800, #f57c00);
            color: white;
            border: none;
            padding: 12px 25px;
            font-size: 16px;
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
            margin: 10px;
            transition: all 0.3s ease;
        }

        .retry-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(255, 152, 0, 0.3);
        }

        @media (max-width: 600px) {
            .scanner-container {
                padding: 20px;
                margin: 10px;
            }
            
            .scanner-title {
                font-size: 24px;
            }
        }
    </style>
</head>
<body>
    <div class="scanner-container">
        <h1 class="scanner-title">üì± Barcode Scanner</h1>
        <p class="scanner-subtitle">Scan QR codes and barcodes instantly</p>
        
        <button id="startScan" class="scan-button">
            üîç Start Scanning
        </button>
        
        <button id="retryButton" class="retry-button scanner-hidden">
            üîÑ Try Again
        </button>
        
        <div id="loadingSpinner" class="loading-spinner scanner-hidden"></div>
        
        <div id="reader" class="scanner-hidden"></div>
        
        <button id="stopScan" class="stop-button scanner-hidden">
            ‚èπÔ∏è Stop Scanning
        </button>
        
        <div id="statusMessage"></div>
        
        <div id="debugInfo" class="debug-info scanner-hidden"></div>
        
        <div id="result" class="scanner-hidden">
            <h3>Scanned Result:</h3>
            <p id="scannedText"></p>
        </div>
    </div>

    <script>
        class BarcodeScanner {
            constructor() {
                this.html5QrcodeScanner = null;
                this.isScanning = false;
                this.isInIframe = window.self !== window.top;
                this.retryCount = 0;
                this.maxRetries = 3;
                
                this.initializeElements();
                this.setupEventListeners();
                this.checkIframeMode();
                this.checkEnvironment();
            }

            initializeElements() {
                this.startButton = document.getElementById('startScan');
                this.stopButton = document.getElementById('stopScan');
                this.retryButton = document.getElementById('retryButton');
                this.readerDiv = document.getElementById('reader');
                this.statusDiv = document.getElementById('statusMessage');
                this.resultDiv = document.getElementById('result');
                this.scannedTextDiv = document.getElementById('scannedText');
                this.loadingSpinner = document.getElementById('loadingSpinner');
                this.debugInfoDiv = document.getElementById('debugInfo');
            }

            setupEventListeners() {
                this.startButton.addEventListener('click', () => this.startScanning());
                this.stopButton.addEventListener('click', () => this.stopScanning());
                this.retryButton.addEventListener('click', () => this.retryScanning());
            }

            checkIframeMode() {
                if (this.isInIframe) {
                    document.body.classList.add('iframe-mode');
                }
            }

            async checkEnvironment() {
                const debugInfo = [];
                
                // Check HTTPS
                debugInfo.push(`Protocol: ${window.location.protocol}`);
                
                // Check if it's localhost or secure context
                debugInfo.push(`Secure Context: ${window.isSecureContext}`);
                
                // Check MediaDevices API
                debugInfo.push(`MediaDevices API: ${!!navigator.mediaDevices}`);
                debugInfo.push(`getUserMedia: ${!!navigator.mediaDevices?.getUserMedia}`);
                
                // Check camera permissions
                try {
                    const permissionStatus = await navigator.permissions.query({ name: 'camera' });
                    debugInfo.push(`Camera Permission: ${permissionStatus.state}`);
                } catch (e) {
                    debugInfo.push(`Camera Permission: Not supported`);
                }
                
                this.debugInfoDiv.innerHTML = debugInfo.join('<br>');
            }

            showStatus(message, type = 'info') {
                this.statusDiv.innerHTML = message;
                this.statusDiv.className = `status-message status-${type}`;
                this.statusDiv.style.display = 'block';
            }

            hideStatus() {
                this.statusDiv.style.display = 'none';
            }

            showLoading() {
                this.loadingSpinner.classList.remove('scanner-hidden');
                this.startButton.disabled = true;
            }

            hideLoading() {
                this.loadingSpinner.classList.add('scanner-hidden');
                this.startButton.disabled = false;
            }

            showRetryButton() {
                this.retryButton.classList.remove('scanner-hidden');
            }

            hideRetryButton() {
                this.retryButton.classList.add('scanner-hidden');
            }

            showDebugInfo() {
                this.debugInfoDiv.classList.remove('scanner-hidden');
            }

            async retryScanning() {
                this.retryCount++;
                this.hideRetryButton();
                await this.startScanning();
            }

            async requestCameraPermission() {
                try {
                    // Try to access camera to trigger permission request
                    const stream = await navigator.mediaDevices.getUserMedia({ 
                        video: { 
                            facingMode: 'environment' // Prefer back camera
                        } 
                    });
                    
                    // Stop the stream immediately
                    stream.getTracks().forEach(track => track.stop());
                    return true;
                } catch (error) {
                    console.error('Camera permission error:', error);
                    return false;
                }
            }

            async startScanning() {
                try {
                    this.showLoading();
                    this.hideStatus();
                    this.hideRetryButton();

                    // Check secure context
                    if (!window.isSecureContext) {
                        throw new Error('Camera access requires HTTPS or localhost');
                    }

                    // Check MediaDevices API
                    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                        throw new Error('Camera API not supported in this browser');
                    }

                    // Request camera permission explicitly
                    this.showStatus('üîê Requesting camera permission...', 'info');
                    const hasPermission = await this.requestCameraPermission();
                    
                    if (!hasPermission) {
                        throw new Error('Camera permission denied or not available');
                    }

                    // Get available cameras
                    this.showStatus('üì∑ Detecting cameras...', 'info');
                    let cameras;
                    
                    try {
                        cameras = await Html5Qrcode.getCameras();
                    } catch (cameraError) {
                        console.error('Error getting cameras:', cameraError);
                        throw new Error('Failed to detect cameras: ' + cameraError.message);
                    }

                    if (!cameras || cameras.length === 0) {
                        throw new Error('No cameras found on this device');
                    }

                    console.log('Available cameras:', cameras);

                    // Initialize scanner
                    this.showStatus('üîß Initializing scanner...', 'info');
                    this.html5QrcodeScanner = new Html5Qrcode("reader");
                    
                    // Scanner configuration
                    const config = {
                        fps: 10,
                        qrbox: function(viewfinderWidth, viewfinderHeight) {
                            let minEdgePercentage = 0.7;
                            let minEdgeSize = Math.min(viewfinderWidth, viewfinderHeight);
                            let qrboxSize = Math.floor(minEdgeSize * minEdgePercentage);
                            return {
                                width: qrboxSize,
                                height: qrboxSize
                            };
                        },
                        aspectRatio: 1.0,
                        supportedScanTypes: [Html5QrcodeScanType.SCAN_TYPE_CAMERA]
                    };

                    // Try different cameras starting with back camera
                    let cameraStarted = false;
                    const cameraIds = cameras.map(camera => camera.id);
                    
                    // Prefer environment (back) camera
                    const backCamera = cameras.find(camera => 
                        camera.label.toLowerCase().includes('back') || 
                        camera.label.toLowerCase().includes('environment')
                    );
                    
                    if (backCamera) {
                        cameraIds.unshift(backCamera.id);
                    }

                    for (const cameraId of cameraIds) {
                        try {
                            this.showStatus(`üì∑ Starting camera: ${cameras.find(c => c.id === cameraId)?.label || 'Unknown'}`, 'info');
                            
                            await this.html5QrcodeScanner.start(
                                cameraId,
                                config,
                                (decodedText, decodedResult) => this.onScanSuccess(decodedText, decodedResult),
                                (errorMessage) => this.onScanFailure(errorMessage)
                            );
                            
                            cameraStarted = true;
                            break;
                        } catch (startError) {
                            console.warn(`Failed to start camera ${cameraId}:`, startError);
                            if (cameraId === cameraIds[cameraIds.length - 1]) {
                                throw startError; // This was the last camera, throw the error
                            }
                        }
                    }

                    if (!cameraStarted) {
                        throw new Error('Failed to start any available camera');
                    }

                    this.isScanning = true;
                    this.startButton.classList.add('scanner-hidden');
                    this.stopButton.classList.remove('scanner-hidden');
                    this.readerDiv.classList.remove('scanner-hidden');
                    this.hideLoading();
                    this.showStatus('‚úÖ Camera active! Point at a QR code or barcode to scan.', 'success');
                    this.retryCount = 0; // Reset retry count on success

                } catch (error) {
                    this.hideLoading();
                    console.error('Error starting scanner:', error);
                    
                    let errorMessage = '‚ùå ';
                    
                    if (error.message.includes('Permission denied') || error.message.includes('permission denied')) {
                        errorMessage += 'Camera access denied. Please click the camera icon in your browser\'s address bar and allow camera access.';
                    } else if (error.message.includes('HTTPS') || error.message.includes('secure')) {
                        errorMessage += 'Camera requires HTTPS connection. Please use a secure connection.';
                    } else if (error.message.includes('No cameras found')) {
                        errorMessage += 'No camera detected on this device.';
                    } else if (error.message.includes('Camera API not supported')) {
                        errorMessage += 'Your browser doesn\'t support camera access. Try updating your browser.';
                    } else if (error.message.includes('Camera already in use')) {
                        errorMessage += 'Camera is being used by another application. Please close other camera apps.';
                    } else if (error.message.includes('not available') || error.message.includes('not found')) {
                        errorMessage += 'Camera is not available. Check if another app is using it.';
                    } else {
                        errorMessage += `Failed to start camera: ${error.message}`;
                    }
                    
                    this.showStatus(errorMessage, 'error');
                    this.showDebugInfo();
                    
                    // Show retry button if not exceeded max retries
                    if (this.retryCount < this.maxRetries) {
                        this.showRetryButton();
                    }
                }
            }

            async stopScanning() {
                try {
                    if (this.html5QrcodeScanner && this.isScanning) {
                        await this.html5QrcodeScanner.stop();
                        this.html5QrcodeScanner.clear();
                    }
                } catch (error) {
                    console.error('Error stopping scanner:', error);
                } finally {
                    this.isScanning = false;
                    this.startButton.classList.remove('scanner-hidden');
                    this.stopButton.classList.add('scanner-hidden');
                    this.readerDiv.classList.add('scanner-hidden');
                    this.hideStatus();
                    this.hideRetryButton();
                }
            }

            onScanSuccess(decodedText, decodedResult) {
                console.log('Scan successful:', decodedText);
                
                // Stop scanning
                this.stopScanning();
                
                // Show success message
                this.showStatus(`‚úÖ Successfully scanned: ${decodedText}`, 'success');
                
                // Display result
                this.scannedTextDiv.textContent = decodedText;
                this.resultDiv.classList.remove('scanner-hidden');
                
                // Handle redirection
                this.handleScanResult(decodedText);
            }

            onScanFailure(errorMessage) {
                // Suppress frequent "no code found" messages
                if (!errorMessage.includes('No QR code found') && !errorMessage.includes('NotFoundException')) {
                    console.log('Scan error:', errorMessage);
                }
            }

            handleScanResult(scannedCode) {
                const redirectUrl = `https://shahiassets.com/m/scan/results?mid=${encodeURIComponent(scannedCode)}`;
                
                if (this.isInIframe) {
                    try {
                        // Send message to parent window
                        window.parent.postMessage({
                            type: 'SCAN_RESULT',
                            data: {
                                scannedCode: scannedCode,
                                redirectUrl: redirectUrl
                            }
                        }, '*');
                        
                        // Fallback: try to redirect parent directly after delay
                        setTimeout(() => {
                            try {
                                window.parent.location.href = redirectUrl;
                            } catch (e) {
                                // If that fails, redirect current window
                                window.location.href = redirectUrl;
                            }
                        }, 1500);
                        
                    } catch (error) {
                        console.error('Error communicating with parent frame:', error);
                        window.location.href = redirectUrl;
                    }
                } else {
                    // Direct redirect for standalone mode
                    setTimeout(() => {
                        window.location.href = redirectUrl;
                    }, 2000);
                }
            }
        }

        // Initialize scanner when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            window.barcodeScanner = new BarcodeScanner();
        });

        // Handle messages from parent frame
        window.addEventListener('message', (event) => {
            if (event.data.type === 'START_SCAN' && window.barcodeScanner) {
                if (!window.barcodeScanner.isScanning) {
                    window.barcodeScanner.startScanning();
                }
            }
        });

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (window.barcodeScanner && window.barcodeScanner.isScanning) {
                window.barcodeScanner.stopScanning();
            }
        });
    </script>
</body>
</html>
