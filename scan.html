<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Barcode Scanner</title>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/minified/html5-qrcode.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .scanner-container {
            background: white;
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            max-width: 500px;
            width: 100%;
            text-align: center;
        }

        .scanner-title {
            font-size: 28px;
            font-weight: 700;
            color: #333;
            margin-bottom: 10px;
        }

        .scanner-subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 16px;
        }

        .scan-button {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 18px;
            font-weight: 600;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
        }

        .scan-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4);
        }

        .scan-button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .stop-button {
            background: linear-gradient(45deg, #f44336, #d32f2f);
            color: white;
            border: none;
            padding: 12px 25px;
            font-size: 16px;
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
            margin: 10px;
            transition: all 0.3s ease;
        }

        .stop-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(244, 67, 54, 0.3);
        }

        #reader {
            margin: 20px auto;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .status-message {
            margin: 15px 0;
            padding: 12px;
            border-radius: 8px;
            font-weight: 500;
        }

        .status-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status-info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .permission-request {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }

        .scanner-hidden {
            display: none;
        }

        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 10px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .iframe-mode {
            background: white;
            min-height: auto;
            padding: 10px;
        }

        .iframe-mode .scanner-container {
            box-shadow: none;
            padding: 10px;
        }

        @media (max-width: 600px) {
            .scanner-container {
                padding: 20px;
                margin: 10px;
            }
            
            .scanner-title {
                font-size: 24px;
            }
        }
    </style>
</head>
<body>
    <div class="scanner-container">
        <h1 class="scanner-title">üì± Barcode Scanner</h1>
        <p class="scanner-subtitle">Scan QR codes and barcodes instantly</p>
        
        <button id="startScan" class="scan-button">
            üîç Start Scanning
        </button>
        
        <div id="loadingSpinner" class="loading-spinner scanner-hidden"></div>
        
        <div id="reader" class="scanner-hidden"></div>
        
        <button id="stopScan" class="stop-button scanner-hidden">
            ‚èπÔ∏è Stop Scanning
        </button>
        
        <div id="statusMessage"></div>
        
        <div id="result" class="scanner-hidden">
            <h3>Scanned Result:</h3>
            <p id="scannedText"></p>
        </div>
    </div>

    <script>
        class BarcodeScanner {
            constructor() {
                this.html5QrcodeScanner = null;
                this.isScanning = false;
                this.isInIframe = window.self !== window.top;
                
                this.initializeElements();
                this.setupEventListeners();
                this.checkIframeMode();
            }

            initializeElements() {
                this.startButton = document.getElementById('startScan');
                this.stopButton = document.getElementById('stopScan');
                this.readerDiv = document.getElementById('reader');
                this.statusDiv = document.getElementById('statusMessage');
                this.resultDiv = document.getElementById('result');
                this.scannedTextDiv = document.getElementById('scannedText');
                this.loadingSpinner = document.getElementById('loadingSpinner');
            }

            setupEventListeners() {
                this.startButton.addEventListener('click', () => this.startScanning());
                this.stopButton.addEventListener('click', () => this.stopScanning());
            }

            checkIframeMode() {
                if (this.isInIframe) {
                    document.body.classList.add('iframe-mode');
                }
            }

            showStatus(message, type = 'info') {
                this.statusDiv.innerHTML = message;
                this.statusDiv.className = `status-message status-${type}`;
                this.statusDiv.style.display = 'block';
            }

            hideStatus() {
                this.statusDiv.style.display = 'none';
            }

            showLoading() {
                this.loadingSpinner.classList.remove('scanner-hidden');
                this.startButton.disabled = true;
            }

            hideLoading() {
                this.loadingSpinner.classList.add('scanner-hidden');
                this.startButton.disabled = false;
            }

            async checkCameraPermission() {
                try {
                    // Check if camera permission is already granted
                    const permissionStatus = await navigator.permissions.query({ name: 'camera' });
                    
                    if (permissionStatus.state === 'denied') {
                        this.showStatus('‚ùå Camera access denied. Please enable camera permissions in your browser settings.', 'error');
                        return false;
                    }

                    if (permissionStatus.state === 'prompt') {
                        this.showStatus('üì∑ Camera permission required. Please allow access when prompted.', 'info');
                    }

                    return true;
                } catch (error) {
                    console.log('Permission API not supported, proceeding with camera access request');
                    return true;
                }
            }

            async startScanning() {
                try {
                    this.showLoading();
                    this.hideStatus();

                    // Check camera permission
                    const hasPermission = await this.checkCameraPermission();
                    if (!hasPermission) {
                        this.hideLoading();
                        return;
                    }

                    // Check if camera is available
                    const cameras = await Html5Qrcode.getCameras();
                    if (!cameras || cameras.length === 0) {
                        throw new Error('No cameras found on this device');
                    }

                    // Initialize scanner
                    this.html5QrcodeScanner = new Html5Qrcode("reader");
                    
                    // Start scanning with optimized config
                    const config = {
                        fps: 10,
                        qrbox: { width: 250, height: 250 },
                        aspectRatio: 1.0,
                        supportedScanTypes: [
                            Html5QrcodeScanType.SCAN_TYPE_CAMERA
                        ]
                    };

                    // Use the best available camera (usually back camera on mobile)
                    const cameraId = cameras.length > 1 ? cameras[1].id : cameras[0].id;

                    await this.html5QrcodeScanner.start(
                        cameraId,
                        config,
                        (decodedText, decodedResult) => this.onScanSuccess(decodedText, decodedResult),
                        (errorMessage) => this.onScanFailure(errorMessage)
                    );

                    this.isScanning = true;
                    this.startButton.classList.add('scanner-hidden');
                    this.stopButton.classList.remove('scanner-hidden');
                    this.readerDiv.classList.remove('scanner-hidden');
                    this.hideLoading();
                    this.showStatus('üì∑ Camera active. Position the code within the frame to scan.', 'info');

                } catch (error) {
                    this.hideLoading();
                    console.error('Error starting scanner:', error);
                    
                    let errorMessage = 'Failed to start camera. ';
                    if (error.message.includes('Permission denied')) {
                        errorMessage += 'Camera access was denied. Please allow camera permissions and try again.';
                    } else if (error.message.includes('No cameras found')) {
                        errorMessage += 'No camera found on this device.';
                    } else if (error.message.includes('Camera already in use')) {
                        errorMessage += 'Camera is being used by another application.';
                    } else {
                        errorMessage += 'Please check your camera permissions and try again.';
                    }
                    
                    this.showStatus('‚ùå ' + errorMessage, 'error');
                }
            }

            async stopScanning() {
                try {
                    if (this.html5QrcodeScanner && this.isScanning) {
                        await this.html5QrcodeScanner.stop();
                        this.html5QrcodeScanner.clear();
                    }
                } catch (error) {
                    console.error('Error stopping scanner:', error);
                } finally {
                    this.isScanning = false;
                    this.startButton.classList.remove('scanner-hidden');
                    this.stopButton.classList.add('scanner-hidden');
                    this.readerDiv.classList.add('scanner-hidden');
                    this.hideStatus();
                }
            }

            onScanSuccess(decodedText, decodedResult) {
                console.log('Scan successful:', decodedText);
                
                // Stop scanning
                this.stopScanning();
                
                // Show success message
                this.showStatus(`‚úÖ Successfully scanned: ${decodedText}`, 'success');
                
                // Display result
                this.scannedTextDiv.textContent = decodedText;
                this.resultDiv.classList.remove('scanner-hidden');
                
                // Handle redirection
                this.handleScanResult(decodedText);
            }

            onScanFailure(errorMessage) {
                // Suppress frequent error messages to avoid spam
                if (!errorMessage.includes('No QR code found')) {
                    console.log('Scan error:', errorMessage);
                }
            }

            handleScanResult(scannedCode) {
                const redirectUrl = `https://shahiassets.com/m/scan/results?mid=${encodeURIComponent(scannedCode)}`;
                
                // If running in iframe (NocoBase), use parent window navigation
                if (this.isInIframe) {
                    try {
                        // Try to redirect parent window
                        window.parent.postMessage({
                            type: 'SCAN_RESULT',
                            data: {
                                scannedCode: scannedCode,
                                redirectUrl: redirectUrl
                            }
                        }, '*');
                        
                        // Fallback: try to redirect parent directly
                        setTimeout(() => {
                            window.parent.location.href = redirectUrl;
                        }, 1000);
                        
                    } catch (error) {
                        console.error('Error communicating with parent frame:', error);
                        // Last resort: redirect current frame
                        window.location.href = redirectUrl;
                    }
                } else {
                    // If not in iframe, redirect current window
                    setTimeout(() => {
                        window.location.href = redirectUrl;
                    }, 2000);
                }
            }
        }

        // Initialize scanner when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            new BarcodeScanner();
        });

        // Handle messages from parent frame (for NocoBase integration)
        window.addEventListener('message', (event) => {
            if (event.data.type === 'START_SCAN') {
                const scanner = window.barcodeScanner;
                if (scanner && !scanner.isScanning) {
                    scanner.startScanning();
                }
            }
        });

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (window.barcodeScanner && window.barcodeScanner.isScanning) {
                window.barcodeScanner.stopScanning();
            }
        });
    </script>
</body>
</html>
