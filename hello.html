<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Machine PDF Generator</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/4.7.7/handlebars.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
  <h2>Machine ID PDF Generator</h2>
  <button id="downloadBtn" style="padding:10px 20px;">Download PDF</button>

  <script>
    let receivedData = null;

    // Listen for data from parent (NocoBase)
    window.addEventListener("message", (event) => {
      receivedData = event.data;
      console.log("Received from parent:", receivedData);
    });

    // PDF generation function
    document.getElementById("downloadBtn").addEventListener("click", () => {
      if (!receivedData || !receivedData.machines) {
        alert("No machine data received yet!");
        return;
      }

      // Handlebars template for machine list
      const source = `
        <h3>Machine List</h3>
        <ul>
        {{#each machines}}
          <li>Machine ID: {{id}}</li>
        {{/each}}
        </ul>
      `;

      const template = Handlebars.compile(source);
      const html = template(receivedData);

      // Convert HTML to plain text for PDF
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.setFontSize(14);
      doc.text("Machine List", 10, 10);

      let y = 20;
      receivedData.machines.forEach((m, index) => {
        doc.text(`${index + 1}. Machine ID: ${m.id}`, 10, y);
        y += 10;
      });

      doc.save(receivedData.filename + ".pdf");
    });
  </script>
</body>
</html>
